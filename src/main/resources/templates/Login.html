<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <section layout:fragment="body" style="background-color: #2B3035;">
        <div class="container">

            <!-- FORMULARIO LOGIN -->
            <form method="post" th:action="@{/login}" style="padding-top: 10px;">
                <div class="row d-flex align-items-center justify-content-center">
                    <!-- Mensaje de logout -->
                    <div id="logoutMessage" th:if="${logout}" th:text="${logout}" class="alert alert-success text-center fs-5" role="alert"></div>

                    <!-- Mensaje de error -->
                    <div id="errorMessage" th:if="${error}" th:text="${error}" class="alert alert-danger text-center fs-5" role="alert"></div>
                </div>

                <div class="row d-flex align-items-center justify-content-center">
                    <!-- Imagen izquierda -->
                    <div class="col-md-8 col-lg-7 col-xl-6">
                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-login-form/draw2.svg" class="img-fluid" alt="Phone image">
                    </div>

                    <!-- FORMULARIO DE INICIO DE SESIÓN -->
                    <div class="col-md-7 col-lg-5 col-xl-5 offset-xl-1">

                        <h4 class="mb-3 text-align-center text-white">INICIA SESIÓN</h4>

                        <!-- Username -->
                        <div class="form-outline mb-4">
                            <label class="form-label text-white" for="formUsername">Username</label>
                            <input type="text" id="formUsername" name="username" class="form-control form-control-lg" required/>
                        </div>

                        <!-- Password -->
                        <div class="form-outline mb-4">
                            <label class="form-label text-white" for="formPassword">Password</label>
                            <input type="password" id="formPassword" name="password" class="form-control form-control-lg" required/>
                        </div>

                        <!-- Botón login -->
                        <div class="d-flex justify-content-around align-items-center mb-4">
                            <button type="submit" class="btn btn-primary btn-lg btn-block">Sign in</button>
                        </div>

                        <hr style="border-color: white">

                        <!-- Enlace de recuperación de contraseña -->
                        <div class="text-center mt-3">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">¿Olvidaste tu contraseña?</a>
                        </div>
                    </div>
                </div>
            </form><!-- FIN LOGIN FORM -->
            

            <!-- Modal para Olvidaste tu contraseña -->
            <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Restablecer contraseña</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        
                        <div class="modal-body">
                            <form id="forgotForm">
                                <div class="mb-3">
                                    <label for="identifier" class="form-label">Username o correo electrónico</label>
                                    <input type="text" class="form-control" id="identifier" placeholder="Tu username o correo" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Enviar enlace</button>
                            </form>
                        </div>
                        
                    </div>
                </div>
            </div><!-- TERMINA MODAL -->

        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
        document.getElementById("forgotForm").addEventListener("submit", async (e) => 
        {
          e.preventDefault();
          const identifier = document.getElementById("identifier").value;

          const res = await fetch("http://localhost:8080/auth/forgotpassword", 
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identifier })
          });

          const data = await res.json();

          if (res.ok) 
          {
            Swal.fire({
              icon: 'success',
              title: 'Correo enviado',
              text: data.message,
              confirmButtonColor: '#3085d6'
            });
          } else 
          {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'No se pudo enviar el correo',
              confirmButtonColor: '#d33'
            });
          }
        });
        </script>

        <script th:if="${waitingVerification}">
            const pendingUsername = /*[[${pendingUsername}]]*/ '';
            let remaining = 120; // 2 minutos
            let intervalId = null;
            let pollingId = null;

            function updateTimer() 
            {
                remaining--;
                const m = String(Math.floor(remaining / 60)).padStart(2, '0');
                const s = String(remaining % 60).padStart(2, '0');
                Swal.update(
                        {
                            html: `<div style="font-size:14px">Te enviamos un correo de verificación.<br/>Revisa tu bandeja y da clic en "Verificar cuenta".<br/><br/><b>Tiempo restante:</b> ${m}:${s}</div>`
                });
                if (remaining <= 0) 
                {
                    clearInterval(intervalId);
                    clearInterval(pollingId);
                    Swal.fire(
                            {
                                icon: 'error',
                                title: 'Token expirado',
                                text: 'El token de verificación expiró. ¿Quieres reenviar el correo?',
                                showCancelButton: true,
                                confirmButtonText: 'Reenviar',
                                cancelButtonText: 'Cancelar'
                            }).then(result => 
                            {
                                if (result.isConfirmed) 
                                {
                                    resendVerification();
                                }
                            });
                 }
            }

            function startPolling() 
            {
                pollingId = setInterval(async () => 
                {
                    try 
                    {
                        const r = await fetch(`http://localhost:8080/auth/verification-status?username=${encodeURIComponent(pendingUsername)}`);
                        const j = await r.json();
                        if (j.verified === true) 
                        {
                            clearInterval(intervalId);
                            clearInterval(pollingId);
                            Swal.update({ title: '¡Cuenta verificada!', icon: 'success', html: 'Redirigiendo...' });
                            setTimeout(() => 
                            {
                                window.location.href = '/usuario';
                            }, 900);
                        }
                    } catch(e) { /* ignorar */ }
                }, 3000);
            }

            async function resendVerification() 
            {
                try 
                {
                    const form = new FormData();
                    form.append('username', pendingUsername);
                    const r = await fetch('http://localhost:8080/auth/resend-verification', { method: 'POST', body: form });
                    const j = await r.json();
                    if (j.ok || j.message) 
                    {
                        remaining = 120;
                        Swal.fire(
                                {
                            icon: 'info',
                            title: 'Correo reenviado',
                            text: 'Hemos enviado un nuevo enlace. Empezamos de nuevo la espera.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => 
                        {
                            // Reiniciar modal + timers
                            waitModal();
                        });
                    } else 
                    {
                        Swal.fire('Error', 'No se pudo reenviar el correo', 'error');
                    }
                } catch(e) 
                {
                    Swal.fire('Error', 'No se pudo reenviar el correo', 'error');
                }
            }

            function waitModal() 
            {
                Swal.fire(
                        {
                            title: 'Esperando la validación',
                            html: '',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                    didOpen: () => 
                    {
                        Swal.showLoading();
                        remaining = 120;
                        updateTimer();
                        intervalId = setInterval(updateTimer, 1000);
                        startPolling();
                    }
                });
            }

            // Lanzar modal de espera al cargar
            waitModal();
        </script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function ()
            {
                function desvanecerMensaje(id)
                {
                    const msg = document.getElementById(id);
                    if (msg)
                    {
                        setTimeout(() =>
                        {
                            msg.classList.add("fade");
                            msg.style.opacity = "0";
                            setTimeout(() => msg.remove(), 1000);
                        }, 3000);
                    }
                }
                desvanecerMensaje("errorMessage");
                desvanecerMensaje("logoutMessage");
            });

            const resetModal = document.getElementById('resetModal');
            resetModal.addEventListener('show.bs.modal', event =>
            {
                const button = event.relatedTarget;
                const recipient = button?.getAttribute('data-bs-whatever') || 'nuevo password';
                const modalTitle = resetModal.querySelector('.modal-title');
                modalTitle.textContent = 'Recuperar ' + recipient;
            });

            function validarPasswords()
            {
                var pass = document.getElementById("password").value;
                var confirmPass = document.getElementById("confirmPassword").value;

                if (pass != confirmPass)
                {
                    alert("Las contraseñas no coinciden.");
                } else
                {
                    document.getElementById("userForm").submit();
                }
            }

            $(document).ready(function ()
            {
                $("#paisddl").change(function ()
                {
                    $.ajax(
                            {
                                type: "GET",
                                url: "http://127.0.0.1:8080/api/estado/pais/" + $("#paisddl").val(),
                                contentType: "application/json",
                                dataType: 'json',
                                success: function (data, textStatus, jqXHR)
                                {
                                    if (data.correct)
                                    {
                                        $("#estadoddl").empty();
                                        $("#estadoddl").append("<option value=0 selected>Selecciona un estado</option>");
                                        $("#municipioddl").empty();
                                        $("#municipioddl").append("<option value=0 selected>Selecciona un municipio</option>");
                                        $("#coloniaddl").empty();
                                        $("#coloniaddl").append("<option value=0 selected>Selecciona una colonia</option>");
                                        console.log("Respuesta del servidor:", data.object);
                                        $.each(data.object, function (indice, estado)
                                        {
                                            $("#estadoddl").append("<option value=" + estado.idEstado + ">" + estado.nombre + "</option>");
                                        });
                                    } else
                                    {
                                        console.log("No hay datos");
                                    }
                                }, error: function (jqXHR, textStatus, errorThrown)
                                {
                                    alert("Algo ha salido mal.");
                                }
                            });
                });


                $("#estadoddl").change(function ()
                {
                    $.ajax(
                            {
                                type: "GET",
                                url: "http://127.0.0.1:8080/api/municipio/estado/" + $("#estadoddl").val(),
                                contentType: "application/json",
                                dataType: "json",
                                success: function (data, textStatus, jqXHR)
                                {
                                    if (data.correct)
                                    {
                                        $("#municipioddl").empty();
                                        $("#municipioddl").append("<option value=0 selected>Selecciona un municipio</option>");
                                        $.each(data.object, function (indice, municipio)
                                        {
                                            $("#municipioddl").append("<option value=" + municipio.idMunicipio + ">" + municipio.nombre + "</option>");
                                        });
                                    } else
                                    {
                                        console.log("No hay datos");
                                    }
                                }, error: function (textStatus, jqXHR, errorThrown)
                                {
                                    alert("Algo ha salido mal.");
                                }
                            });
                });


                $("#municipioddl").change(function ()
                {
                    $.ajax(
                            {
                                type: "GET",
                                url: "http://127.0.0.1:8080/api/colonia/municipio/" + $("#municipioddl").val(),
                                contentType: "application/json",
                                dataType: "json",
                                success: function (data, textStatus, jqXHR)
                                {
                                    if (data.correct)
                                    {
                                        $("#coloniaddl").empty();
                                        $("#coloniaddl").append("<option value=0 selected>Selecciona una colonia</option>");
                                        $.each(data.object, function (indice, colonia)
                                        {
                                            $("#coloniaddl").append("<option value=" + colonia.idColonia + ">" + colonia.nombre + "</option>");
                                            $("#coloniaddl").change(function ()
                                            {
                                                $("#codigoPostal").val(colonia.codigoPostal);
                                            })
                                        });
                                    } else
                                    {
                                        console.log("No hay datos");
                                    }
                                }, error: function (textStatus, jqXHR, errorThrown)
                                {
                                    alert("Algo ha salido mal.");
                                }
                            });
                });
            });
        </script>
    </section>
</html>